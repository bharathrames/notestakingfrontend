import React, { useState, useEffect } from 'react';
import axios from 'axios';
import Dashboard from './components/Dashboard';
import Register from './components/Register';
import Login from './components/Login';



function App() {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [token, setToken] = useState('');
  const [notes, setNotes] = useState([]);
  const [title, setTitle] = useState('');
  const [content, setContent] = useState('');
  const [keyword, setKeyword] = useState('');
  const [editMode, setEditMode] = useState(false);
  const [editNoteId, setEditNoteId] = useState(null);
  const [searchResults, setSearchResults] = useState([]);

  const apiUrl = 'http://localhost:5000';

  const fetchNotes = async () => {
    try {
      const response = await axios.get(`${apiUrl}/dashboard/notes/${username}`, {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      setNotes(response.data.notes);
    } catch (error) {
      console.error('Error fetching notes:', error);
    }
  };

  useEffect(() => {
    if (token) {
      fetchNotes();
    }
  }, [username, token, editMode]);

  const handleRegister = async () => {
    try {
      const response = await axios.post(`${apiUrl}/register`, {
        username,
        password,
      });
      console.log(response.data);
    } catch (error) {
      console.error('Error registering user:', error);
    }
  };

  const handleLogin = async () => {
    try {
      const response = await axios.post(`${apiUrl}/login`, {
        username,
        password,
      });
      setToken(response.data.token);
    } catch (error) {
      console.error('Error logging in:', error);
    }
  };

  const handleAddNote = async () => {
    try {
      await axios.post(
        `${apiUrl}/dashboard/note`,
        {
          username,
          title,
          content,
        },
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );
      setTitle('');
      setContent('');
      fetchNotes(); // Fetch updated notes immediately after adding a new note
    } catch (error) {
      console.error('Error adding note:', error);
    }
  };

  const handleUpdateNote = async () => {
    try {
      await axios.put(
        `${apiUrl}/dashboard/note/${username}/${editNoteId}`,
        {
          title,
          content,
        },
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );
      setTitle('');
      setContent('');
      setEditMode(false);
      setEditNoteId(null);
    } catch (error) {
      console.error('Error updating note:', error);
    }
  };

  const handleDeleteNote = async (noteId) => {
    try {
      await axios.delete(`${apiUrl}/dashboard/note/${username}/${noteId}`, {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      fetchNotes(); // Refresh the notes after delete
    } catch (error) {
      console.error('Error deleting note:', error);
    }
  };

  const handleEditNote = (noteId) => {
    const noteToEdit = notes.find((note) => note._id === noteId);
    if (noteToEdit) {
      setTitle(noteToEdit.title);
      setContent(noteToEdit.content);
      setEditMode(true);
      setEditNoteId(noteId);
    }
  };

  const handleCancelEdit = () => {
    setTitle('');
    setContent('');
    setEditMode(false);
    setEditNoteId(null);
  };
  
  const handleSearch = async () => {
    try {
      console.log('Before Search - Keyword:', keyword);
      const response = await axios.get(`${apiUrl}/dashboard/search/${username}`, {
        params: { keyword },
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      console.log('After Search - Response:', response.data);
      setSearchResults(response.data.notes);  // Update search results state
    } catch (error) {
      console.error('Error searching notes:', error);
    }
  };
  const handleUsernameChange = (e) => setUsername(e.target.value);
  const handlePasswordChange = (e) => setPassword(e.target.value);
  const handleTitleChange = (e) => setTitle(e.target.value);
  const handleContentChange = (e) => setContent(e.target.value);

  return (
    <div>
      <h1>My Notes App</h1>
      {token ? (
        <Dashboard
          title={title}
          content={content}
          keyword={keyword}
          setKeyword={setKeyword} 
          notes={notes}
          handleTitleChange={handleTitleChange}
          handleContentChange={handleContentChange}
          handleAddNote={handleAddNote}
          handleUpdateNote={handleUpdateNote}
          handleEditNote={handleEditNote}
          handleDeleteNote={handleDeleteNote}
          handleSearch={handleSearch}
          searchResults={searchResults} 
          handleCancelEdit={handleCancelEdit}
          editMode={editMode}
        />
      ) : (
        <>
          <Register
            username={username}
            password={password}
            handleUsernameChange={handleUsernameChange}
            handlePasswordChange={handlePasswordChange}
            handleRegister={handleRegister}
          />
          <Login
            username={username}
            password={password}
            handleUsernameChange={handleUsernameChange}
            handlePasswordChange={handlePasswordChange}
            handleLogin={handleLogin}
          />
        </>
      )}
    </div>
  );
}

export default App;
////////////////////////////////////////////////////////////
// Dashboard.js
import React from 'react';

const Dashboard = ({
  title,
  content,
  keyword,
  setKeyword,
  notes,
  handleTitleChange,
  handleContentChange,
  searchResults,
  handleAddNote,
  handleUpdateNote,
  handleEditNote,
  handleDeleteNote,
  handleSearch,
  handleCancelEdit,
  editMode,
}) => (
  <div>
    <h2>Notes</h2>
    <div>
      <label>Title: </label>
      <input type="text" value={title} onChange={handleTitleChange} />
    </div>
    <div>
      <label>Content: </label>
      <textarea value={content} onChange={handleContentChange} />
    </div>
    <div>
      {editMode ? (
        <>
          <button onClick={handleUpdateNote}>Update Note</button>
          <button onClick={handleCancelEdit}>Cancel</button>
        </>
      ) : (
        <button onClick={handleAddNote}>Add Note</button>
      )}
    </div>
    <div>
      <label>Search: </label>
      <input type="text" value={keyword} onChange={(e) => setKeyword(e.target.value)} />
      <button onClick={handleSearch}>Search</button>
    </div>
    <ul>
      {/* Display either searchResults or all notes based on search state */}
      {(searchResults.length > 0 ? searchResults : notes).map((note) => (
        <li key={note._id}>
          <strong>{note.title}</strong>: {note.content}
          <button onClick={() => handleEditNote(note._id)}>Edit</button>
          <button onClick={() => handleDeleteNote(note._id)}>Delete</button>
        </li>
      ))}
    </ul>
  </div>
);

export default Dashboard;
